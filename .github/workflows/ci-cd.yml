name: Django CI/CD Pipeline

on:
  push:
<<<<<<< HEAD
    branches: [dev]
=======
    branches:
      - dev
>>>>>>> dev

  workflow_dispatch:
    inputs:
      image_tag:
        description: "Docker image tag"
        required: true
      environment:
        description: "Deployment environment"
        required: true
<<<<<<< HEAD
        default: "dev"
=======
        default: "prod"
>>>>>>> dev
      dockerfile:
        description: "Dockerfile to use"
        required: true
        default: "Dockerfile"
env:
  IMAGE_NAME: "${{ secrets.DOCKER_USERNAME }}/django-app"
  PYTHON_VERSION: "3.11"
  DOCKER_CONTAINER_DEV: "django-app-Dev"
  DOCKER_CONTAINER_MAIN: "django-app-Main"

  
jobs:
  dev-ci-cd:
    if: github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout dev branch
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        run: |
          python manage.py test

      - name: Docker login
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login \
          -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Build Docker image (dev)
        run: |
          docker build -f Dockerfile \
          -t ${{ env.IMAGE_NAME }}:dev-${{ github.sha }} .

<<<<<<< HEAD

                                    
=======
>>>>>>> dev
      - name: Push Docker image
        run: |
          docker tag ${{ env.IMAGE_NAME }}:dev-${{ github.sha }} ${{ env.IMAGE_NAME }}:dev-latest
          docker push ${{ env.IMAGE_NAME }}:dev-latest
<<<<<<< HEAD


=======
    
>>>>>>> dev
      - name: Deploy to Dev Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            docker pull ${{ env.IMAGE_NAME }}:dev-latest
<<<<<<< HEAD
            CONTAINERS=$(docker ps -q --filter "publish=8000")
            if [ -n "$CONTAINERS" ]; then
             echo "Stopping containers using port 8000..."
             docker rm -f $CONTAINERS
            fi
=======
            docker stop ${{env.DOCKER_CONTAINER_DEV}} || true
            docker rm ${{env.DOCKER_CONTAINER_DEV}} || true
>>>>>>> dev
            docker run -d \
              --name ${{env.DOCKER_CONTAINER_DEV}}  \
              -p 8000:8000 \
              ${{ env.IMAGE_NAME }}:dev-latest

<<<<<<< HEAD
  
  merge-dev-to-main:
    needs: dev-ci-cd
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Configure git
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
      - name: Merge dev into main
        run: |
          git checkout main
          git pull origin main
          git merge origin/dev --no-ff -m "Auto merge dev into main"
          git push origin main
=======
  # AUTO MERGE DEV â†’ MAIN
 
  auto-merge:
    if: github.ref == 'refs/heads/dev'
    needs: dev-ci-cd
    runs-on: ubuntu-latest

    steps:
      - name: Merge dev into main
        uses: pascalgn/automerge-action@v0.16.4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MERGE_METHOD: squash
>>>>>>> dev

 
  # Main DEPLOY

  main-deploy:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
<<<<<<< HEAD
=======
    needs: auto-merge
>>>>>>> dev
    environment: production

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Docker login
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login \
          -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Build Docker image (main)
        run: |
          docker build \
          -f ${{ inputs.dockerfile }} \
          -t ${{ env.IMAGE_NAME }}:${{ inputs.image_tag }} .

      - name: Push Docker image
        run: |
          docker push ${{ env.IMAGE_NAME }}:${{ inputs.image_tag }}

      - name: Deploy to Production
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            docker pull ${{ env.IMAGE_NAME }}:${{ inputs.image_tag }}
<<<<<<< HEAD
            CONTAINERS=$(docker ps -q --filter "publish=8000")
            if [ -n "$CONTAINERS" ]; then
             echo "Stopping containers using port 8000..."
             docker rm -f $CONTAINERS
            fi
            docker run -d --name ${{ env.DOCKER_CONTAINER_MAIN }} \
            -p 8000:8000 --restart unless-stopped \
            ${{ env.IMAGE_NAME }}:${{ inputs.image_tag }}
=======
            docker stop ${{env.DOCKER_CONTAINER_MAIN}} || true
            docker rm ${{env.DOCKER_CONTAINER_MAIN}} || true
            docker run -d \
              --env ENV=${{ inputs.environment }} \
              -p 8000:8000 \
              ${{ env.IMAGE_NAME }}:${{ inputs.image_tag }}
>>>>>>> dev
